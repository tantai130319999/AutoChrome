var chrome=chrome||browser,permissions={};function getId(t){return document.getElementById(t)}function isodate(t){let e=t.getMonth()+1,n=t.getDate();return e<10&&(e="0"+e),n<10&&(n="0"+n),t.getFullYear()+"-"+e+"-"+n}function changeClass(t,e,n,r){getId(t).classList.replace(n,r),setTimeout(()=>{getId(t).classList.replace(r,n)},1e3*e)}function testXpath(t){try{document.evaluate(t,document,null,XPathResult.ANY_TYPE,null)}catch(t){return!1}return!0}function openOptions(){let t=!1;chrome.tabs.query({currentWindow:!0},function(e){e.forEach(function(e){e.url.search("https://autorefresh.io/options/")>=0&&(console.log("done"),t=!0,chrome.tabs.update(e.id,{active:!0},null))}),t||chrome.tabs.create({url:"https://autorefresh.io/options"})})}function startBtn(t){"stop"==t?(getId("startbtn").dataset.state="Stop",getId("btn-start-msg").innerHTML=chrome.i18n.getMessage("stop"),getId("startbtn").classList.replace("btn-primary","btn-secondary"),getId("startbtn").classList.add("btn-stop")):(getId("startbtn").dataset.state="Start",getId("btn-start-msg").innerHTML=chrome.i18n.getMessage("start_msg"),getId("startbtn").classList.replace("btn-secondary","btn-primary"),getId("startbtn").classList.remove("btn-stop"))}function timerBtn(t){"stop"==t?(getId("timerbtn").dataset.state="Cancel Timer",getId("timerbtn_msg").innerHTML=chrome.i18n.getMessage("cancel_timer"),getId("timerbtn").classList.replace("btn-primary","btn-secondary"),getId("timerbtn").classList.add("btn-stop")):(getId("timerbtn").dataset.state="Start Timer",getId("timerbtn_msg").innerHTML=chrome.i18n.getMessage("start_timer"),getId("timerbtn").classList.replace("btn-secondary","btn-primary"),getId("timerbtn").classList.remove("btn-stop"))}var domainData={get(t,e){chrome.storage?chrome.storage.local.get("domain_config",function(n){let r=n.domain_config;if(r){let n=r[t];e&&e(null==n?null:n)}else e&&e(null)}):e&&e(null)},set(t,e,n){if(!chrome.storage)return;let r=chrome.storage.local;r.get("domain_config",function(a){let i=a.domain_config;i||(i={}),i[t]=e,r.set({domain_config:i},()=>{n&&n(i)})})}};function domainParse(t){if(""==t||!t)return"";let e,n=t.toString(),r=(e=n.search("http://")>-1||n.search("https://")>-1?t:new URL("http://"+n).href).toString();return r=r.replace("www.","")}function _ut(){var t=new CustomEvent("updateTag",null);document.dispatchEvent(t)}function get_interval(){var t=new Array,e=5e3,n=document.getElementsByName("reloadOption"),r=n.length;for(i=0;i<r;i++)if(n[i].checked)if("rand"==n[i].value){var a=$("#tmin").val()-0,o=$("#tmax").val()-0;e=a>o?o+"-"+a:a+"-"+o,t[0]=e,t[1]="rand"}else if("custom"==n[i].value){var s=$("#tcustom").val()-0;s<0?(e=1e3,$("#tcustom").val("1")):e=Math.round(1e3*s),t[0]=e,t[1]="custom"}else if("timer"==n[i].value){var c=$("#int_timerHour").val()-0,u=$("#int_timerMin").val()-0,l=$("#int_timerSec").val()-0;t[0]=c+"-"+u+"-"+l,t[1]="timer"}else e=n[i].value,t[0]=e,t[1]="stand";return t}function set_interval(t,e){if("custom"==e)return getId("r08").checked=!0,void(getId("tcustom").value=t/1e3);if("rand"==e){getId("r07").checked=!0;var n=t.split("-");return getId("tmin").value=n[0],void(getId("tmax").value=n[1])}if("timer"==e){getId("r10").checked=!0;n=t.split("-");return getId("int_timerHour").value=n[0],getId("int_timerMin").value=n[1],void(getId("int_timerSec").value=n[2])}var r=document.getElementsByName("reloadOption"),a=r.length;for(i=0;i<a;i++)if(r[i].value==t)return void(r[i].checked=!0)}var tagInputManager=function(t,e){let n=getId(t);var r,a;(n.setAttribute("tag-value",e),""!=e)&&(r=n.parentElement,a=e.split("[^or]"),function(t){const e=t.querySelectorAll(".tag");e.length<1||e.forEach(t=>{const e=t.parentElement;e&&e.removeChild(t)})}(r),a.slice().reverse().forEach(function(t){const e=function(t){const e=document.createElement("span");e.classList.add("tag"),e.innerHTML=t;const n=document.createElement("span");return"@@"==t.substring(0,2)?testXpath(t.replace("@@",""))?e.classList.add("xpath"):e.classList.add("fail"):"##"===t.substring(0,2)?e.classList.add("custom-exp"):"$"===t.substring(0,1)&&(t=>(t=t.replace("$","")).match(/\/(.+)\/.*/))(t)&&e.classList.add("regex-exp"),n.classList.add("close-btn"),n.setAttribute("data-item",t),e.appendChild(n),e}(t);r.prepend(e)}))};function requestPermissions(){return new Promise((t,e)=>{let n={};permissions.host||(n.origins=["http://*/*","https://*/*"]),function(e){chrome.permissions.request(e,e=>{e?(permissions.host=!0,t()):alert("Host permissions are required")})}(n)})}function checkPermissions(t=null){chrome.permissions.getAll(e=>{e.origins&&-1!==e.origins.indexOf("http://*/*")&&-1!==e.origins.indexOf("https://*/*")&&(permissions.host=!0),t&&t()})}function dynamicOptions(t,e){if(e&&set_interval(t.time_interval,t.time_type),t.checkme&&(tagInputManager("contentid",t.checkme||""),t.openLink&&(getId("pgeMntrLink").checked=t.openLink),t.inNewTab&&(getId("pgeMntrLinkInNewTab").checked=t.inNewTab),_ut()),t.hardRefresh&&(getId("hard-refresh").checked=t.hardRefresh),t.refreshNumber&&(getId("srn-input").classList.add("active"),getId("set-refresh-num").checked=t.refreshNumber),t.setRefNumber&&(getId("srn-input").value=t.setRefNumber),t.pmOptions){let e=t.pmOptions;"2"==e.type?getId("page--monitor-default").click():getId("page--monitor-custom").click(),getId("visual").checked=e.visual||!1,getId("source").checked=e.source||!1}t.pm_p_type&&("B"==t.pm_p_type?getId("page--monitor-custom-2").click():getId("page--monitor-custom-1").click()),t.timerInterval&&("number"==typeof t.timerInterval?getId("countdown--option-1").click():getId("countdown--option-2").click(),setTimerInput({wait_time:t.timerInterval}),startEvents())}function saveCustomData(){var t=get_interval();chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(chrome.runtime.lastError)return;let n={};n.checkme=getId("contentid").getAttribute("tag-value")||getId("contentid").value,n.pm_p_type=1==getId("page--monitor-custom-2").checked?"B":"A",n.openLink=getId("pgeMntrLink").checked,n.inNewTab=getId("pgeMntrLinkInNewTab").checked,n.time_type=t[1],n.time_interval=t[0],n.randomInterval={min:getId("tmin").value,max:getId("tmax").value},n.timerInterval=getTimeOfTimer(),n.hardRefresh=getId("hard-refresh").checked,n.refreshNumber=getId("set-refresh-num").checked,n.setRefNumber=getId("srn-input").value,n.preurl="true"==localStorage.pdcheck?domainParse(localStorage.pdurl):null,n.pmOptions={type:1==getId("page--monitor-default").checked?"2":"1",visual:getId("visual").checked,source:getId("source").checked},e&&domainData.set(e[0].url,n)})}function recvData(t){"start"==t.status?(startBtn("stop"),timerBtn("start")):"wait"==t.status?(startBtn("stop"),timerBtn("stop")):(startBtn("start"),timerBtn("start")),t.wait_time&&setTimerInput(t)}function startEvents(){document.addEventListener("change",function(t){saveCustomData()})}function restoreOptions(){if($("#monitorbox").show(),localStorage.default_time&&set_interval(1e3*localStorage.default_time,"custom"),localStorage.defaultpgtxt&&localStorage.defaultpgtxt.length>0&&(getId("custom--cta").style.display="inline-block"),"true"==localStorage.random_time&&$("#randombox").css("display","flex"),localStorage.timercheck&&"true"==localStorage.timercheck){$("#timerbox").show();var t=new Date((new Date).getTime()+6e5);let n=t.getHours(),r=t.getMinutes(),a=t.getSeconds();n<10&&(n="0"+n),r<10&&(r="0"+r),a<10&&(a="0"+a);var e=n+":"+r+":"+a;$("#timeInp").val(e)}else document.querySelector("[rel='tab-countdown']").style.display="none";chrome.tabs.query({active:!0,currentWindow:!0},function(t){domainData.get(t[0].url,e=>{if(null!=e){let t="rand"!=e.time_type;t||(t="true"==localStorage.random_time),dynamicOptions(e,t)}else startEvents();chrome.runtime.sendMessage({name:"tabInfo",id:t[0].id},function(t){recvData(t.data)})})})}function stopFunc(){startBtn("start"),timerBtn("start");var t=chrome.extension.getViews();for(var e in t)t[e].loop_stop&&t[e].loop_stop()}function inputError(t,e){e?getId(t).classList.add("error"):getId(t).classList.remove("error")}function validateInterval(t){let e=!0;return"custom"==t[1]?"0"==t[0]?(e=!1,inputError("tcustom",!0)):inputError("tcustom",!1):"rand"==t[1]?"0"==getId("tmin").value||"0"==getId("tmax").value?(e=!1,"0"==getId("tmin").value?inputError("tmin",!0):inputError("tmin",!1),"0"==getId("tmax").value?inputError("tmax",!0):inputError("tmax",!1)):(inputError("tmin",!1),inputError("tmax",!1)):"timer"==t[1]&&("0-0-0"==t[0]?(e=!1,getId("r10").closest("div").classList.add("error")):getId("r10").closest("div").classList.remove("error")),e}function startRefresh(t=-1,e=!1){if(permissions.host){var n=get_interval();if(!validateInterval(n))return;if(""!=getId("contentid").value){let t=getId("contentid").getAttribute("tag-value"),e="";e=t?t+"[^or]"+getId("contentid").value:getId("contentid").value,getId("contentid").value="",tagInputManager("contentid",e||""),_ut()}var r=function(){var e=chrome.extension.getViews(),r=getId("contentid").getAttribute("tag-value")||getId("contentid").value,a="true"==localStorage.pdcheck?domainParse(localStorage.pdurl):null;let i=1==getId("page--monitor-default").checked?"2":"1",o=getId("pgeMntrLink").checked,s=getId("pgeMntrLinkInNewTab").checked,c=getId("visual").checked,u=getId("source").checked,l={openLink:o,inNewTab:s,hardRefresh:getId("hard-refresh").checked,refreshNumber:getId("set-refresh-num").checked,setRefNumber:getId("srn-input").value,pmOptions:{type:i,visual:c,source:u}};for(var d in saveCustomData(),e){var m=1==getId("page--monitor-custom-2").checked?"B":"A";if(e[d].loop_start){let i=e[d];chrome.tabs.query({currentWindow:!0,active:!0,windowType:"normal"},function(e){chrome.runtime.lastError,i.loop_start(e[0],t,n[0],n[1],r,m,a,l)})}}};e?(startBtn("stop"),r()):"Start"==getId("startbtn").dataset.state?(startBtn("stop"),r()):stopFunc()}else requestPermissions().then(function(){startRefresh(t,e)})}function getTimeOfTimer(){var t;if(getId("countdown--option-1").checked){var e=parseInt(getId("timerHour").value),n=parseInt(getId("timerMin").value),r=parseInt(getId("timerSec").value);isNaN(e)&&(e=0,getId("timerHour").value="0"),isNaN(n)&&(n=0,getId("timerMin").value="0"),isNaN(r)&&(r=0,getId("timerSec").value="0"),t=1e3*(3600*e+60*n+r)}else{var a=getId("dateInp").value,i=new Date(a);if(isNaN(i))return;var o=a+" "+getId("timeInp").value,s=new Date(o);if(isNaN(s))return;new Date;var c=s.getMonth()+1;t=(i=s.getFullYear()+"/"+c+"/"+s.getDate())+" "+(s=s.getHours()+":"+s.getMinutes()+":"+s.getSeconds())}return t}function startTimer(){"Start Timer"==getId("timerbtn").dataset.state?(startRefresh(getTimeOfTimer(),!0),timerBtn("stop")):(timerBtn("start"),stopFunc())}function killSoundsMonitor(){changeClass("mutedBtn",.55,"icon-unmute","icon-mute");var t=chrome.extension.getViews();for(var e in t)t[e].kill_sound&&t[e].kill_sound()}function setTimerInput(t){if(-1==t.wait_time.toString().search(" ")){var e=t.wait_time/1e3,n=Math.floor(e/3600),r=Math.floor((e-3600*n)/60),a=Math.floor(e-3600*n-60*r);getId("timerHour").value=n,getId("timerMin").value=r,getId("timerSec").value=a,$("#timermode").val("1")}else{var i=new Date(t.wait_time),o=i.getMinutes()+1,s=i.getSeconds()+1;o<10&&(o="0"+o),s<10&&(s="0"+s);let e=i.getHours();e<10&&(e="0"+e);var c=e+":"+o+":"+s;$("#dateInp").val(isodate(i)),$("#timeInp").val(c),$("#timermode").val("2")}}var scrollRoot=document.body,header=getId("header"),is_scrolling=!0;function update(){is_scrolling&&(scrollRoot.scrollTop?header.classList.add("scrolled"):header.classList.remove("scrolled"),is_scrolling=!1),requestAnimationFrame(update)}function start(){setTimeout(restoreOptions,1),getId("r08").checked=!0,$("#custom--cta").click(()=>{getId("contentid").value="",tagInputManager("contentid",localStorage.defaultpgtxt||""),_ut(),saveCustomData()}),$("#startbtn").click(()=>{startRefresh()}),$("#r08").click(function(){getId("tcustom").focus()}),$("#tcustom").focus(function(){getId("r08").checked=!0}),$("#r07").click(function(){getId("tmin").focus()}),$("#tmin").focus(function(){getId("r07").checked=!0}),$("#tmax").focus(function(){getId("r07").checked=!0});var t=new Date;getId("dateInp").setAttribute("min",isodate(t)),getId("dateInp").value=isodate(t),$("#mutedBtn").click(killSoundsMonitor),$("#timerbtn").click(startTimer),$("#advancedOptions").click(()=>{openOptions()}),$(".help-text").click(function(t){window.open("https://autorefresh.io/expressions/")}),$("#rating").click(function(t){window.open("https://autorefresh.io/review/")})}update(),document.onscroll=function(){is_scrolling=!0},startI18n(),document.querySelectorAll(".help-btn").forEach(t=>{t.addEventListener("click",t=>{document.body;let e=t.target.closest("button").getAttribute("sd-content");window.open("https://autorefresh.io/help/"+e)})}),$(document).ready(function(){checkPermissions(start),document.querySelectorAll("input").forEach(function(t){t.onchange=function(){"number"==t.type&&(t.step||(t.value=parseInt(t.value)),t.max&&t.value>t.max&&(t.value=t.max),t.min&&t.value<t.min&&(t.value=t.min))}})});
var Match,calculate_operations,consecutive_where,create_index,diff,find_match,find_matching_blocks,html_to_tokens,is_end_of_tag,is_start_of_tag,is_tag,is_whitespace,isnt_tag,op_map,recursively_find_matching_blocks,render_operations,wrap;is_end_of_tag=function(e){return">"===e},is_start_of_tag=function(e){return"<"===e},is_whitespace=function(e){return/^\s+$/.test(e)},is_tag=function(e){return/^\s*<[^>]+>\s*$/.test(e)},isnt_tag=function(e){return!is_tag(e)},Match=class{constructor(e,t,n){this.start_in_before=e,this.start_in_after=t,this.length=n,this.end_in_before=this.start_in_before+this.length-1,this.end_in_after=this.start_in_after+this.length-1}},html_to_tokens=function(e){var t,n,r,i,_,a;for(_="char",n="",a=[],r=0,i=e.length;r<i;r++)switch(t=e[r],_){case"tag":is_end_of_tag(t)?(n+=">",a.push(n),n="",_=is_whitespace(t)?"whitespace":"char"):n+=t;break;case"char":is_start_of_tag(t)?(n&&a.push(n),n="<",_="tag"):/\s/.test(t)?(n&&a.push(n),n=t,_="whitespace"):/[\w\#@]+/i.test(t)?n+=t:(n&&a.push(n),n=t);break;case"whitespace":is_start_of_tag(t)?(n&&a.push(n),n="<",_="tag"):is_whitespace(t)?n+=t:(n&&a.push(n),n=t,_="char");break;default:throw new Error(`Unknown mode ${_}`)}return n&&a.push(n),a},find_match=function(e,t,n,r,i,_,a){var s,o,f,c,h,l,u,d,p,g,b,m,w,k,v;for(o=r,s=_,f=0,b={},l=c=k=r,v=i;k<=v?c<v:c>v;l=k<=v?++c:--c){for(w={},u=0,d=(p=n[e[l]]).length;u<d;u++)if(!((h=p[u])<_)){if(h>=a)break;null==b[h-1]&&(b[h-1]=0),m=b[h-1]+1,w[h]=m,m>f&&(o=l-m+1,s=h-m+1,f=m)}b=w}return 0!==f&&(g=new Match(o,s,f)),g},recursively_find_matching_blocks=function(e,t,n,r,i,_,a,s){var o;return null!=(o=find_match(e,t,n,r,i,_,a))&&(r<o.start_in_before&&_<o.start_in_after&&recursively_find_matching_blocks(e,t,n,r,o.start_in_before,_,o.start_in_after,s),s.push(o),o.end_in_before<=i&&o.end_in_after<=a&&recursively_find_matching_blocks(e,t,n,o.end_in_before+1,i,o.end_in_after+1,a,s)),s},create_index=function(e){var t,n,r,i,_,a;if(null==e.find_these)throw new Error("params must have find_these key");if(null==e.in_these)throw new Error("params must have in_these key");for(r={},t=0,i=(_=e.find_these).length;t<i;t++)for(r[a=_[t]]=[],n=e.in_these.indexOf(a);-1!==n;)r[a].push(n),n=e.in_these.indexOf(a,n+1);return r},find_matching_blocks=function(e,t){var n,r;return r=[],n=create_index({find_these:e,in_these:t}),recursively_find_matching_blocks(e,t,n,0,e.length,0,t.length,r)},calculate_operations=function(e,t){var n,r,i,_,a,s,o,f,c,h,l,u,d,p,g,b;if(null==e)throw new Error("before_tokens?");if(null==t)throw new Error("after_tokens?");for(g=p=0,d=[],n={"false,false":"replace","true,false":"insert","false,true":"delete","true,true":"none"},(l=find_matching_blocks(e,t)).push(new Match(e.length,t.length,0)),_=i=0,f=l.length;i<f;_=++i)"none"!==(r=n[[g===(h=l[_]).start_in_before,p===h.start_in_after].toString()])&&d.push({action:r,start_in_before:g,end_in_before:"insert"!==r?h.start_in_before-1:void 0,start_in_after:p,end_in_after:"delete"!==r?h.start_in_after-1:void 0}),0!==h.length&&d.push({action:"equal",start_in_before:h.start_in_before,end_in_before:h.end_in_before,start_in_after:h.start_in_after,end_in_after:h.end_in_after}),g=h.end_in_before+1,p=h.end_in_after+1;for(b=[],o={action:"none"},a=function(t){return"equal"===t.action&&(t.end_in_before-t.start_in_before==0&&/^\s$/.test(e.slice(t.start_in_before,+t.end_in_before+1||9e9)))},s=0,c=d.length;s<c;s++)a(u=d[s])&&"replace"===o.action||"replace"===u.action&&"replace"===o.action?(o.end_in_before=u.end_in_before,o.end_in_after=u.end_in_after):(b.push(u),o=u);return b},consecutive_where=function(e,t,n){var r,i,_,a,s;for(a=void 0,_=i=0,s=(t=t.slice(e,+t.length+1||9e9)).length;i<s&&(!0===(r=n(t[_]))&&(a=_),!1!==r);_=++i);return null!=a?t.slice(0,+a+1||9e9):[]},wrap=function(e,t){var n,r,i,_,a;for(_="",i=0,n=t.length;!(i>=n||(i+=(r=consecutive_where(i,t,isnt_tag)).length,0!==r.length&&(_+=`<${e}>${r.join("")}</${e}>`),i>=n));)i+=(a=consecutive_where(i,t,is_tag)).length,_+=a.join("");return _},(op_map={equal:function(e,t,n){return t.slice(e.start_in_before,+e.end_in_before+1||9e9).join("")},insert:function(e,t,n){var r;return r=n.slice(e.start_in_after,+e.end_in_after+1||9e9),wrap("ins",r)},delete:function(e,t,n){var r;return r=t.slice(e.start_in_before,+e.end_in_before+1||9e9),wrap("del",r)}}).replace=function(e,t,n){return op_map.delete(e,t,n)+op_map.insert(e,t,n)},render_operations=function(e,t,n){var r,i,_,a;for(a="",r=0,i=n.length;r<i;r++)_=n[r],a+=op_map[_.action](_,e,t);return a},(diff=function(e,t){var n;return e===t?e:(e=html_to_tokens(e),t=html_to_tokens(t),n=calculate_operations(e,t),render_operations(e,t,n))}).html_to_tokens=html_to_tokens,diff.find_matching_blocks=find_matching_blocks,find_matching_blocks.find_match=find_match,find_matching_blocks.create_index=create_index,diff.calculate_operations=calculate_operations,diff.render_operations=render_operations,"function"==typeof define?define([],function(){return diff}):"undefined"!=typeof module&&null!==module?module.exports=diff:this.htmldiff=diff;